name: Deploy Infrastructure

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create directory if not exists
        run: |
          sudo mkdir -p /opt/infrastructure
          sudo chown -R $USER:$USER /opt/infrastructure

      - name: Sync files to /opt/infrastructure
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.env' \
            ./ /opt/infrastructure/

      - name: Generate .env from secrets
        run: |
          cat > /opt/infrastructure/.env << 'EOF'
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          TRAEFIK_DASHBOARD_AUTH=${{ secrets.TRAEFIK_DASHBOARD_AUTH }}
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^[[:space:]]*//' /opt/infrastructure/.env

      - name: Create acme.json for Let's Encrypt
        run: |
          ACME_FILE="/opt/infrastructure/traefik_certs/acme.json"
          if [ ! -f "$ACME_FILE" ]; then
            sudo mkdir -p /opt/infrastructure/traefik_certs
            sudo touch "$ACME_FILE"
            sudo chmod 600 "$ACME_FILE"
            sudo chown $USER:$USER "$ACME_FILE"
          fi

      - name: Start containers
        run: |
          cd /opt/infrastructure
          docker compose up -d --remove-orphans

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          for i in {1..15}; do
            if docker exec infra_postgres pg_isready -U ${POSTGRES_USER:-postgres} 2>/dev/null; then
              echo "Postgres is ready."
              break
            fi
            echo "Waiting for Postgres... attempt $i"
            sleep 2
          done
          sleep 5
          docker logs traefik 2>&1 | tail -20 || true

      - name: Sync Postgres password
        run: |
          docker exec infra_postgres psql -U ${POSTGRES_USER:-postgres} -c \
            "ALTER USER ${POSTGRES_USER:-postgres} WITH PASSWORD '${{ secrets.POSTGRES_PASSWORD }}';"
          echo "Postgres password synced."

      - name: Show status
        run: |
          cd /opt/infrastructure
          docker compose ps
          echo ""
          echo "Infrastructure deployed!"
          echo "Traefik is ready to route traffic"
          echo "Deployed at: $(date)"
