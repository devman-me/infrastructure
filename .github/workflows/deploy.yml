name: Deploy Infrastructure

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create directory if not exists
        run: |
          sudo mkdir -p /opt/infrastructure
          sudo chown -R $USER:$USER /opt/infrastructure

      - name: Sync files to /opt/infrastructure
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.env' \
            ./ /opt/infrastructure/

      - name: Generate .env from secrets
        run: |
          cat > /opt/infrastructure/.env << 'EOF'
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^[[:space:]]*//' /opt/infrastructure/.env

      - name: Start containers
        run: |
          cd /opt/infrastructure
          docker-compose up -d --remove-orphans

      - name: Deploy Nginx configs
        run: |
          sudo mkdir -p /var/www/devman.me
          sudo cp /opt/infrastructure/nginx/*.conf /etc/nginx/sites-available/
          for conf in /opt/infrastructure/nginx/*.conf; do
            name=$(basename "$conf")
            sudo ln -sf /etc/nginx/sites-available/$name /etc/nginx/sites-enabled/
          done
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t && sudo systemctl reload nginx

      - name: Show status
        run: |
          cd /opt/infrastructure
          docker-compose ps
          echo ""
          echo "âœ… Infrastructure deployed!"
          echo "ðŸ“… Deployed at: $(date)"
