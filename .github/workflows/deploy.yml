name: Deploy Infrastructure

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create directory if not exists
        run: |
          sudo mkdir -p /opt/infrastructure
          sudo chown -R $USER:$USER /opt/infrastructure

      - name: Sync files to /opt/infrastructure
        run: |
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.env' \
            ./ /opt/infrastructure/

      - name: Ensure .env exists
        run: |
          if [ ! -f /opt/infrastructure/.env ]; then
            echo "‚ö†Ô∏è  WARNING: /opt/infrastructure/.env not found!"
            echo "Please create it manually with: cp .env.example .env && nano .env"
            exit 1
          fi

      - name: Start containers
        run: |
          cd /opt/infrastructure
          docker-compose up -d --remove-orphans

      - name: Show status
        run: |
          cd /opt/infrastructure
          docker-compose ps
          echo ""
          echo "‚úÖ Infrastructure deployed!"
          echo "üìÖ Deployed at: $(date)"
